<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Approval Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .application-card { transition: all 0.2s; }
    .application-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .badge-pending { background-color: #ffc107; color: #000; }
    .badge-paid { background-color: #fd7e14; color: #fff; }
    .badge-verified { background-color: #28a745; color: #fff; }
    .badge-approved { background-color: #17a2b8; color: #fff; }
    .badge-rejected { background-color: #dc3545; color: #fff; }
    .qr-img { max-width: 200px; max-height: 200px; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="fas fa-user-shield me-2"></i>Payment Approvals</h2>
      <button class="btn btn-outline-danger" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>

    <div class="card shadow">
      <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Applications</h5>
          <button class="btn btn-sm btn-light" onclick="loadApplications()">
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Student</th>
                <th>Internship</th>
                <th>Applied At</th>
                <th>Status</th>
                <th>Payment</th>
                <th>Transaction No</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="applicationsTable">
              <!-- Applications will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Verification Modal -->
  <div class="modal fade" id="verifyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Verify Payment</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="verifyModalBody">
          <!-- Content loaded dynamically -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-success" onclick="confirmVerify()">
            <i class="fas fa-check-circle"></i> Verify Payment
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const BASE = "https://eventdb.onrender.com";
    const token = localStorage.getItem("jwtToken") || "";
    let verifyModal = null;
    let currentApplicationId = null;

    document.addEventListener('DOMContentLoaded', () => {
      verifyModal = new bootstrap.Modal(document.getElementById('verifyModal'));
      
      if (!token) {
        Swal.fire('Error', 'You need to login first', 'error').then(() => {
          window.location.href = 'index.html';
        });
        return;
      }
      
      loadApplications();
    });

    function logout() {
      localStorage.removeItem('jwtToken');
      window.location.href = 'login.html';
    }

    async function loadApplications() {
      try {
        document.getElementById('applicationsTable').innerHTML = `
          <tr>
            <td colspan="7" class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p>Loading applications...</p>
            </td>
          </tr>
        `;
        
        const res = await fetch(`${BASE}/api/admin/applications`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!res.ok) throw new Error('Failed to load applications');
        
        const applications = await res.json();
        renderApplications(applications);
      } catch (err) {
        document.getElementById('applicationsTable').innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-danger">
              Error loading applications: ${err.message}
            </td>
          </tr>
        `;
      }
    }

    function renderApplications(applications) {
      const tableBody = document.getElementById('applicationsTable');
      
      if (applications.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-muted">
              No applications found
            </td>
          </tr>
        `;
        return;
      }
      
      tableBody.innerHTML = applications.map(app => `
        <tr class="application-card">
          <td>
            <strong>${app.student_name}</strong><br>
            <small class="text-muted">${app.email}</small>
          </td>
          <td>
            ${app.position} at ${app.company_name}
          </td>
          <td>${new Date(app.applied_at).toLocaleString()}</td>
          <td>
            <span class="badge rounded-pill ${getStatusClass(app.status)}">
              ${app.status}
            </span>
          </td>
          <td>
            <span class="badge rounded-pill ${getPaymentStatusClass(app.payment_status)}">
              ${app.payment_status || 'unpaid'}
            </span>
          </td>
          <td>${app.transaction_no || 'N/A'}</td>
          <td>
            ${app.payment_status === 'paid' ? `
              <button class="btn btn-sm btn-success" onclick="openVerifyModal(${app.id})">
                <i class="fas fa-check"></i> Verify
              </button>
            ` : ''}
            <button class="btn btn-sm btn-info" onclick="viewApplicationDetails(${app.id})">
              <i class="fas fa-eye"></i> View
            </button>
          </td>
        </tr>
      `).join('');
    }

    function getStatusClass(status) {
      switch (status) {
        case 'approved': return 'badge-approved';
        case 'rejected': return 'badge-rejected';
        default: return 'badge-pending';
      }
    }

    function getPaymentStatusClass(status) {
      switch (status) {
        case 'verified': return 'badge-verified';
        case 'paid': return 'badge-paid';
        default: return 'badge-pending';
      }
    }

    async function openVerifyModal(applicationId) {
      try {
        currentApplicationId = applicationId;
        
        // Get application details
        const res = await fetch(`${BASE}/api/admin/applications`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!res.ok) throw new Error('Failed to load application details');
        
        const applications = await res.json();
        const application = applications.find(app => app.id == applicationId);
        
        if (!application) throw new Error('Application not found');
        
        // Get internship payment QR
        const internshipRes = await fetch(`${BASE}/api/internships/${application.internship_id}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!internshipRes.ok) throw new Error('Failed to load internship details');
        const internship = await internshipRes.json();
        
        // Populate modal
        document.getElementById('verifyModalBody').innerHTML = `
          <div class="mb-3">
            <h6>Student: ${application.student_name}</h6>
            <p>Internship: ${application.position} at ${application.company_name}</p>
            <p>Transaction No: <strong>${application.transaction_no}</strong></p>
          </div>
          ${internship.payment_qr ? `
            <div class="text-center mb-3">
              <p class="mb-2"><strong>Payment QR Code:</strong></p>
              <img src="${internship.payment_qr}" class="img-fluid qr-img border p-2">
            </div>
          ` : ''}
          <div class="alert alert-info">
            Verify that the payment with transaction number <strong>${application.transaction_no}</strong> has been received.
          </div>
        `;
        
        verifyModal.show();
      } catch (err) {
        Swal.fire('Error', err.message, 'error');
      }
    }

    async function confirmVerify() {
      try {
        const res = await fetch(`${BASE}/api/admin/applications/${currentApplicationId}/verify-payment`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          }
        });
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.message || 'Failed to verify payment');
        }
        
        const result = await res.json();
        verifyModal.hide();
        
        Swal.fire({
          title: 'Success!',
          text: result.message,
          icon: 'success',
          confirmButtonText: 'OK'
        });
        
        loadApplications();
      } catch (err) {
        Swal.fire('Error', err.message, 'error');
      }
    }

    function viewApplicationDetails(applicationId) {
      // You can implement this to show more details
      Swal.fire({
        title: 'Application Details',
        text: 'Detailed view would show more information about this application',
        icon: 'info'
      });
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
