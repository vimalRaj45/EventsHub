<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dynamic Quiz App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- Google Outfit Font -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- AOS CSS -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <!-- SweetAlert2 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <style>
    :root {
      --primary-color: #4e73df;
      --primary-light: #e6eaf5;
      --secondary-color: #f8f9fc;
      --accent-color: #2e59d9;
      --correct-color: #28a745;
      --incorrect-color: #dc3545;
      --text-dark: #2d3748;
      --text-medium: #4a5568;
      --text-light: #718096;
      --swal-confirm: var(--primary-color);
    }
    
    body {
      background-color: #f8f9fa;
      font-family: 'Outfit', sans-serif;
      color: var(--text-dark);
      line-height: 1.6;
      -webkit-tap-highlight-color: transparent;
    }
    
    .quiz-container {
      max-width: 800px;
      margin: 1rem auto;
      box-shadow: 0 0.15rem 0.5rem rgba(0, 0, 0, 0.1);
      border-radius: 0.75rem;
      overflow: hidden;
      background: white;
      transition: all 0.3s ease;
    }
    
    .quiz-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
      color: white;
      padding: 1.25rem 1.5rem;
      position: relative;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .quiz-header h2 {
      font-weight: 700;
      margin-bottom: 0;
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      font-size: 1.25rem;
    }
    
    .quiz-body {
      padding: 1.5rem;
      background-color: white;
    }
    
    .question-card {
      margin-bottom: 1.25rem;
      border-left: 4px solid var(--primary-color);
      background-color: var(--secondary-color);
      border-radius: 0.5rem;
      padding: 1rem;
    }
    
    .form-label {
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }
    
    .btn-submit {
      background-color: var(--primary-color);
      border: none;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      box-shadow: 0 2px 4px rgba(78, 115, 223, 0.2);
    }
    
    .progress-container {
      height: 8px;
      background-color: #e9ecef;
      border-radius: 4px;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    
    .progress-bar {
      background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
      transition: width 0.6s ease;
    }
    
    .quiz-icon {
      margin-right: 8px;
      font-size: 1em;
    }
    
    .form-control, .form-select {
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid #e2e8f0;
      font-size: 0.95rem;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
    }
    
    .loading-spinner {
      display: none;
      width: 1.25rem;
      height: 1.25rem;
      border: 0.2em solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .result-modal .modal-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
      color: white;
      border-bottom: none;
      padding: 1.25rem;
    }
    
    .result-badge {
      font-size: 1.1rem;
      padding: 0.5rem 1rem;
      border-radius: 1.5rem;
      font-weight: 600;
    }

    /* Mobile Optimizations */
    .quiz-intro {
      text-align: center;
      padding: 1.5rem;
    }
    
    .quiz-intro-icon {
      font-size: 2.5rem;
      color: var(--primary-color);
      margin-bottom: 0.75rem;
    }
    
    .quiz-intro h3 {
      font-weight: 700;
      margin-bottom: 0.75rem;
      font-size: 1.5rem;
    }
    
    .quiz-intro p {
      color: var(--text-medium);
      margin-bottom: 1.25rem;
      font-size: 0.95rem;
    }
    
    .question-counter {
      margin-bottom: 1rem;
    }
    
    .question-number {
      background-color: var(--primary-light);
      color: var(--primary-color);
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-right: 8px;
      flex-shrink: 0;
      font-size: 0.9rem;
    }
    
    .question-header {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .modal-content {
      border-radius: 0.75rem;
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .result-icon {
      font-size: 3.5rem;
      margin-bottom: 1rem;
    }
    
    #globalTimer {
      position: fixed;
      top: 10px;
      right: 10px;
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 50px;
      font-weight: 600;
      font-size: 0.85rem;
      z-index: 1000;
      display: flex;
      align-items: center;
    }
    
    /* Floating action button for mobile */
    .fab-submit {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 100;
      border: none;
    }
    
    /* Loader for quiz loading */
    .loader-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      text-align: center;
    }
    
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid var(--primary-light);
      border-bottom-color: var(--primary-color);
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
      margin-bottom: 1rem;
    }
    
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Responsive adjustments */
    @media (max-width: 576px) {
      .quiz-container {
        margin: 0.5rem;
        border-radius: 0.5rem;
      }
      
      .quiz-body {
        padding: 1rem;
      }
      
      .quiz-header {
        padding: 1rem;
      }
      
      .quiz-header h2 {
        font-size: 1.1rem;
      }
      
      .fab-submit {
        display: flex;
      }
      
      .desktop-submit {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="quiz-container" data-aos="fade-up" data-aos-duration="800">
    <div class="quiz-header">
      <h2><i class="bi bi-pencil-square quiz-icon"></i> <span id="quizTitle">Quiz</span></h2>
    </div>
    
    <div class="quiz-body">
      <div class="progress-container">
        <div class="progress-bar" id="quizProgress" style="width: 0%"></div>
      </div>
      
      <form id="quizForm"></form>
    </div>
  </div>

  <div id="globalTimer" class="d-flex align-items-center">
    <i class="bi bi-clock"></i>
    <span>Time Left: 00:00</span>
  </div>

  <!-- Floating Action Button for Mobile -->
  <button class="fab-submit" id="mobileSubmitBtn" style="display: none;">
    <i class="bi bi-send"></i>
  </button>

  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- AOS JS -->
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <!-- SweetAlert2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
<script>
  AOS.init();
  const API_URL = "https://script.google.com/macros/s/AKfycbzmp1fwjprEnzwpwt0hNcGE9zLc6TzOwoDRxyGO89wMq6v3PA_gSXt4AspdxXoX2mZrqw/exec";

  const form = document.getElementById("quizForm");
  const quizTitle = document.getElementById("quizTitle");
  const quizProgress = document.getElementById("quizProgress");
  const globalTimer = document.getElementById("globalTimer");
  const mobileSubmitBtn = document.getElementById("mobileSubmitBtn");

  const queryParams = new URLSearchParams(window.location.search);
  const quizName = queryParams.get('quiz') || 'Maths';
  quizTitle.innerText += ` â€“ ${quizName}`;

  let totalTimeout = 0;
  let autoSubmitTimer;
  let globalCountdownTimer;
  let questionsCount = 0;
  let userEmail = '';

  // Show loading state initially
  form.innerHTML = `
    <div class="loader-container">
      <span class="loader"></span>
      <p>Loading quiz questions...</p>
    </div>
  `;

  async function loadQuiz() {
    try {
      const res = await fetch(`${API_URL}?quiz=${quizName}`);
      const data = await res.json();
      const questions = data.questions;
      if (questions.error) throw new Error(questions.error);
      
      questionsCount = questions.length;
      totalTimeout = questions.reduce((total, q) => total + (q.timeout || 2), 0);

      // Show intro screen
      form.innerHTML = `
        <div class="quiz-intro">
          <div class="quiz-intro-icon">
            <i class="bi bi-question-circle"></i>
          </div>
          <h3>${quizName} Quiz</h3>
          <p>This quiz contains ${questionsCount} questions with a total time limit of ${Math.round(totalTimeout / 60)} minutes.</p>
          <div class="mb-3" id="emailField">
            <label class="form-label">Enter your email to begin</label>
            <input type="email" required id="userEmail" class="form-control" placeholder="your@email.com">
          </div>
          <button type="button" class="btn btn-primary px-4 py-2" id="startQuizBtn">
            <i class="bi bi-play-fill me-2"></i> Start Quiz
          </button>
        </div>
      `;

      document.getElementById("startQuizBtn").addEventListener("click", () => {
        const emailInput = document.getElementById("userEmail");
        if (!emailInput.value.trim() || !emailInput.checkValidity()) {
          emailInput.classList.add("is-invalid");
          Swal.fire({
            icon: 'error',
            title: 'Email Required',
            text: 'Please enter a valid email address to continue',
            confirmButtonColor: 'var(--primary-color)'
          });
          return;
        }

        userEmail = emailInput.value.trim();
        showQuizInstructions(questions);
      });

    } catch (err) {
      quizTitle.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i> Quiz Loading Error`;
      form.innerHTML = '';
      Swal.fire({
        icon: 'error',
        title: 'Failed to load quiz',
        text: err.message,
        confirmButtonColor: 'var(--primary-color)'
      });
    }
  }

  function showQuizInstructions(questions) {
    Swal.fire({
      title: 'Quiz Instructions',
      html: `
        <div class="text-start">
          <div class="d-flex align-items-start mb-3">
            <i class="bi bi-clock text-primary me-2 mt-1"></i>
            <div>
              <h6 class="mb-1">Time Limit</h6>
              <p class="mb-0 text-muted">Total time: ${Math.round(totalTimeout / 60)} minutes</p>
            </div>
          </div>
          <div class="d-flex align-items-start mb-3">
            <i class="bi bi-check-circle text-primary me-2 mt-1"></i>
            <div>
              <h6 class="mb-1">Completion</h6>
              <p class="mb-0 text-muted">All answers must be submitted before time</p>
            </div>
          </div>
          <div class="d-flex align-items-start mb-3">
            <i class="bi bi-exclamation-triangle text-primary me-2 mt-1"></i>
            <div>
              <h6 class="mb-1">Timeouts</h6>
              <p class="mb-0 text-muted">Unanswered questions will be marked as timeout</p>
            </div>
          </div>
          <div class="d-flex align-items-start">
            <i class="bi bi-envelope text-primary me-2 mt-1"></i>
            <div>
              <h6 class="mb-1">Email</h6>
              <p class="mb-0 text-muted">Email is required, others are optional</p>
            </div>
          </div>
        </div>
      `,
      confirmButtonText: 'Start Quiz',
      confirmButtonColor: 'var(--primary-color)',
      allowOutsideClick: false,
      backdrop: `
        rgba(0,0,0,0.5)
      `
    }).then(() => {
      // remove email prompt
      form.innerHTML = "";
      buildQuiz(questions);
    });
  }

  function buildQuiz(questions) {
    // Show mobile submit button if on small screen
    if (window.innerWidth <= 576) {
      mobileSubmitBtn.style.display = "flex";
      mobileSubmitBtn.addEventListener("click", () => {
        form.dispatchEvent(new Event('submit'));
      });
    }
    
    const emailField = document.createElement("input");
    emailField.type = "hidden";
    emailField.name = "Email";
    emailField.value = userEmail;
    form.appendChild(emailField);

    questions.forEach((q, index) => {
      const wrapper = document.createElement("div");
      wrapper.classList.add("question-card");
      wrapper.dataset.aos = "fade-up";
      wrapper.dataset.aosDelay = index * 100;
      wrapper.id = `question-${q.name}`;

      const questionHeader = document.createElement("div");
      questionHeader.classList.add("question-header");
      
      const questionNumber = document.createElement("div");
      questionNumber.classList.add("question-number");
      questionNumber.textContent = index + 1;
      questionHeader.appendChild(questionNumber);
      
      const label = document.createElement("label");
      label.textContent = q.question;
      label.classList.add("form-label");
      questionHeader.appendChild(label);
      
      wrapper.appendChild(questionHeader);

      let input;
      if (q.type === "select") {
        input = document.createElement("select");
        input.classList.add("form-select");
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "Select an option";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        input.appendChild(defaultOption);
        
        q.options.forEach(opt => {
          const option = document.createElement("option");
          option.value = opt.trim();
          option.textContent = opt.trim();
        if (opt.trim().toLowerCase() === "timeout") {
  option.hidden = true; // hide, but DO NOT disable
}

          input.appendChild(option);
        });
      } else {
        input = document.createElement("input");
        input.type = q.type || "text";
        input.classList.add("form-control");
        input.placeholder = "Type your answer here...";
      }

      input.name = q.name;
      input.required = false;
      wrapper.appendChild(input);
      form.appendChild(wrapper);
    });

    // Add submit button
    const submitWrapper = document.createElement("div");
    submitWrapper.classList.add("d-grid", "gap-2", "mt-3", "desktop-submit");
    submitWrapper.innerHTML = `
      <button type="submit" class="btn btn-primary btn-submit" id="submitBtn">
        <span id="submitText">Submit Answers</span>
        <span class="loading-spinner" id="submitSpinner" style="display: none;"></span>
      </button>
    `;
    form.appendChild(submitWrapper);

    // Update progress bar
    quizProgress.style.width = `${100/questionsCount}%`;

    startGlobalCountdown(totalTimeout);
    startAutoSubmit(totalTimeout);
  }

  function startGlobalCountdown(seconds) {
    let remaining = seconds;
    updateTimerDisplay(remaining);
    globalCountdownTimer = setInterval(() => {
      remaining--;
      updateTimerDisplay(remaining);
      
      if (remaining === 60) {
        Swal.fire({
          icon: 'warning',
          title: '1 Minute Left!',
          text: 'Hurry up! The quiz will auto-submit in 1 minute',
          confirmButtonColor: 'var(--primary-color)',
          timer: 5000
        });
      }
      
      if (remaining <= 0) {
        clearInterval(globalCountdownTimer);
      }
    }, 1000);
  }

  function updateTimerDisplay(seconds) {
    const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
    const secs = String(seconds % 60).padStart(2, '0');
    globalTimer.innerHTML = `<i class="bi bi-clock"></i><span>Time Left: ${mins}:${secs}</span>`;
    
    if (seconds <= 60) {
      globalTimer.style.background = "linear-gradient(135deg, #ffc107 0%, #fd7e14 100%)";
    } else if (seconds <= 120) {
      globalTimer.style.background = "linear-gradient(135deg, #fd7e14 0%, #dc3545 100%)";
    }
  }


  form.addEventListener("submit", async (e) => {
    // Prevent default only if this is a user-initiated submission
    const isUserSubmission = !e.detail?.isAutoSubmit;
    
    if (isUserSubmission) {
      e.preventDefault();
      
      const { isConfirmed } = await Swal.fire({
        title: 'Confirm Submission',
        text: 'Are you sure you want to submit your answers?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: 'var(--primary-color)',
        cancelButtonColor: 'var(--incorrect-color)',
        confirmButtonText: 'Yes, submit!',
        cancelButtonText: 'No, continue'
      });
      
      if (!isConfirmed) {
        return; // User canceled, don't submit
      }
      
      // User confirmed, proceed with submission
      submitQuiz();
    } else {
      // This is an auto-submit from timeout, proceed immediately
      submitQuiz();
    }
  });

  async function submitQuiz() {
  const submitText = document.getElementById("submitText");
  const submitSpinner = document.getElementById("submitSpinner");
  const submitBtn = document.getElementById("submitBtn");

  submitText.textContent = "Submitting...";
  submitSpinner.style.display = "inline-block";
  submitBtn.disabled = true;

  if (mobileSubmitBtn) {
    mobileSubmitBtn.disabled = true;
    mobileSubmitBtn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i>';
  }

  const formData = new FormData(form);
  const data = {};
  formData.forEach((v, k) => data[k] = v);
  data.quiz = quizName;
  console.log("ðŸ“‹ Submitting answers:", data);

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify(data)
    });

    const result = await res.json();

    // Reset UI states
    submitText.textContent = "Submit Answers";
    submitSpinner.style.display = "none";
    submitBtn.disabled = false;

    if (mobileSubmitBtn) {
      mobileSubmitBtn.disabled = false;
      mobileSubmitBtn.innerHTML = '<i class="bi bi-send"></i>';
    }

    // Show thank you alert (no score)
    if (result.success) {
      Swal.fire({
        title: 'ðŸŽ‰ Thank You for Attending!',
        html: `
          <div class="text-center">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
            <p class="mt-3">Your responses have been submitted.</p>
            <p class="small text-muted">A confirmation has been sent to <strong>${userEmail}</strong></p>
            <p class="small text-muted mb-0">Please wait for your result.</p>
          </div>
        `,
        confirmButtonText: 'OK',
        confirmButtonColor: 'var(--primary-color)'
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Submission Failed',
        text: result.error || "An unknown error occurred",
        confirmButtonColor: 'var(--primary-color)'
      });
    }

  } catch (err) {
    submitText.textContent = "Submit Answers";
    submitSpinner.style.display = "none";
    submitBtn.disabled = false;

    if (mobileSubmitBtn) {
      mobileSubmitBtn.disabled = false;
      mobileSubmitBtn.innerHTML = '<i class="bi bi-send"></i>';
    }

    Swal.fire({
      icon: 'error',
      title: 'Network Error',
      text: 'Failed to submit quiz. Please check your connection.',
      confirmButtonColor: 'var(--primary-color)'
    });
  }
}


function startAutoSubmit(seconds) {
  autoSubmitTimer = setTimeout(() => {
    const allElements = form.querySelectorAll('input[name], textarea[name], select[name]');
    const timedOutFields = [];

    // First: Force timeout value for unanswered fields
    allElements.forEach(el => {
      if (el.name && el.name !== "Email") {
        const isSelect = el.tagName.toLowerCase() === "select";
        const isEmpty = isSelect ? el.value === "" : !el.value.trim();

        if (isEmpty) {
          el.value = "timeout";

          if (isSelect) {
            // Ensure timeout option exists & is selected
            let timeoutOption = Array.from(el.options).find(opt => opt.value === "timeout");
            if (!timeoutOption) {
              timeoutOption = new Option("timeout", "timeout", true, true);
              el.appendChild(timeoutOption);
            } else {
              timeoutOption.selected = true;
            }
          }

          el.dispatchEvent(new Event('input', { bubbles: true }));
          el.dispatchEvent(new Event('change', { bubbles: true }));

          timedOutFields.push({
            name: el.name,
            type: el.tagName.toLowerCase(),
            label: el.closest('.question-card')?.querySelector('label')?.innerText || 'Unknown'
          });
        }
      }
    });

    // âœ… Now build FormData AFTER all values have been updated
    const currentData = new FormData(form);

    // ðŸ” Log timeout fields
    if (timedOutFields.length > 0) {
      console.log("â±ï¸ The following fields were auto-filled as 'timeout':");
      console.table(timedOutFields);
    } else {
      console.log("âœ… All fields were answered. No timeouts inserted.");
    }

    // ðŸ“¤ Trigger auto-submission
    setTimeout(() => {
      console.log("ðŸ“‹ Auto-submitting final answers...");
      const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
      submitEvent.detail = { isAutoSubmit: true };
      form.dispatchEvent(submitEvent);
    }, 50);
  }, seconds * 1000);
}



  document.addEventListener('DOMContentLoaded', loadQuiz);
</script>
</body>
</html>
